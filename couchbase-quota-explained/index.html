
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Couchbase Quota Explained - Ivan Vari</title>
  <meta name="author" content="Ivan Vari">

  
  <meta name="description" content="Couchbase quota is a simple thing but misunderstanding or misconfiguring its limits can have impact on your performance or data integrity.">
  <meta name="keywords" content="couchbase,quota,explained,persitence,memory limits,resident ratio">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://ivanvari.com/couchbase-quota-explained/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ivan Vari" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
    <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Anton" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Oswald" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Voltaire" rel="stylesheet" type="text/css">
  <!--Fonts-Awesome Web font directory for aside icons -->
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" />
  <!-- Redirect users to https after Cloudfare setup complete -->
  <script type="text/javascript">
  var host = "ivanvari.com";
      if ((host == window.location.host) && (window.location.protocol != "https:"))
          window.location.protocol = "https";
  </script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-84719456-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ivan Vari</a></h1>
  
    <h2>A minimalist Sysop/Devops Craftsman</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="ivanvari.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Couchbase Quota Explained</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-10-16T00:28:13+02:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:28 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>For modern, high performance web applications we need low latency and Couchbase excels in that. To maintain the lowest possible latency even during node failure,
we need to achieve 100% resident ratio for our high performance buckets. This means that Couchbase serves all your data from RAM, even the least frequently accessed ones,
disk is used for persistence only. It turns out that in this condition your usable RAM is lot less, 2 thirds of your allocated quota.</p>

<!--more-->


<p>I always found it hard to come up with a number for bucket quota. It depends on the key size which can vary, the number of keys expected to be stored, your expiry
on keys, etc. So what we do is essentially oversize the buckets initially (as long as we can afford it with RAM of course), then observe and perhaps adjust it later on
but this gets harder when you start utilising your cluster RAM.</p>

<p><img src="/images/2013-10/CFDD97C6-310B-11E3-AD2F-001D095D855C.jpg" /></p>

<p>I had a solid understanding of the &ldquo;mem_low_wat&rdquo; and &ldquo;mem_high_wat&rdquo; watermarks, I just didn&rsquo;t know their impact and how their values are calculated.
The <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-introduction-architecture-ejection-eviction.html" target="_blank">working set management guide</a>
explains this, I am not going to repeat what is discussed in that, just reflect what happens in real life.</p>

<p>In my case the default ratio (per bucket):</p>

<p><strong>mem_low_wat = ~60%</strong> (of your dynamic RAM quota)</p>

<p><strong>mem_high_wat = ~75%</strong> (of your dynamic RAM quota)</p>

<blockquote><p>In nutshell: when a certain amount of RAM is consumed by items, the server will eject items starting with replica data. This threshold is known as the low water mark.
If higher threshold is breached, Couchbase Server will not only eject replica data, it will also eject less-frequently used items.</p>

<p>This ejection happens at node level.</p></blockquote>

<p>I have always monitored both, the resident ratios and of course the quotas but missed the &ldquo;low&rdquo; and especially the &ldquo;high&rdquo; watermarks. This turned out to be problematic
in the last couple of weeks, our cluster lost it&rsquo;s harmony and we started fetching from disk which adds an extra 100-200us latency to our average GETs occasionally.
One of my buckets is somewhat large, currently the quota is set to 100GB (400GB across 4 nodes) and the bucket holds 500+ Million keys. If you consider the ratio above,
the default behaviour sets the &ldquo;mem_high_wat&rdquo; to 100GB, that is a lot of RAM to be wasted!</p>

<p><strong>Explanation:</strong></p>

<p>In layman&rsquo;s term:  it&rsquo;s a buffer, it&rsquo;s a protection against unexpected large write spike, node failure, manual failover, rebalance, etc. If the bucket&rsquo;s memory usage
reaches 90% of its quota allocation, the application would start throwing &ldquo;temporary out of memory errors&rdquo; which would of course need to be handled some ways.
If an application is not coded to handle this type of exception, writes/reads may fail.</p>

<p>While these watermarks can be changed on per node / per bucket basis, it&rsquo;s strongly recommended not to do so as it can potentially put your data at risk.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ivan Vari</span></span>

      




<time class='entry-date' datetime='2013-10-16T00:28:13+02:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:28 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/clustering/'>clustering</a>, <a class='category' href='/blog/categories/database/'>database</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://ivanvari.com/couchbase-quota-explained/" data-via="" data-counturl="https://ivanvari.com/couchbase-quota-explained/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/couchbase-1-8-persistence/" title="Previous Post: Couchbase 1.8 Persistence">&laquo; Couchbase 1.8 Persistence</a>
      
      
        <a class="basic-alignment right" href="/integrating-networks-vpn-amazon-vpc/" title="Next Post: Integrating networks over VPN with Amazon VPC">Integrating networks over VPN with Amazon VPC &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section id="aside-icons">
<span class="fa-stack fa-lg">
  <a href="mailto:ivan.adam.vari@ivanvari.com">
    <i class="fa fa-circle fa-stack-2x "></i>
    <i class="fa fa-envelope fa-stack-1x fa-inverse "></i>
  </a>
</span>
<span class="fa-stack fa-lg">
  <a href="https://github.com/variia">
    <i class="fa fa-github fa-stack-2x"></i>
  </a>
</span>
<span class="fa-stack fa-lg">
  <a href="https://www.linkedin.com/profile/view?id=ADEAAAZ6wwEBp7FjAqg_m7ZK8y148UI70Cyn9n8">
    <i class="fa fa-circle fa-stack-2x "></i>
    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
  </a>
</span>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/aws-console-mfa-1password-otp-automation/">AWS MFA Enabled Console With Automated One Time Password</a>
      </li>
    
      <li class="post">
        <a href="/solving-poor-performance-on-rhel-and-centos-7/">Solving Poor Network Performance on RHEL and CentOS 7</a>
      </li>
    
      <li class="post">
        <a href="/conditional-snat-with-irule-on-f5/">Conditional SNAT With iRule on F5</a>
      </li>
    
      <li class="post">
        <a href="/solving-openvpn-poor-throughput-and-packet-loss/">Solving OpenVPN Poor Throughput and Packet Loss</a>
      </li>
    
      <li class="post">
        <a href="/merging-pillars-in-saltstack/">Merging Pillars in SaltStack</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/amazon-web-services/'>amazon web services (1)</a></li><li><a href='/blog/categories/cloud/'>cloud (1)</a></li><li><a href='/blog/categories/clustering/'>clustering (3)</a></li><li><a href='/blog/categories/database/'>database (3)</a></li><li><a href='/blog/categories/hardware/'>hardware (1)</a></li><li><a href='/blog/categories/java/'>java (1)</a></li><li><a href='/blog/categories/linux/'>linux (1)</a></li><li><a href='/blog/categories/macos/'>macos (1)</a></li><li><a href='/blog/categories/network/'>network (4)</a></li><li><a href='/blog/categories/python/'>python (3)</a></li><li><a href='/blog/categories/saltstack/'>saltstack (2)</a></li><li><a href='/blog/categories/security/'>security (3)</a></li></ul>
</section>
<section>
  <h1>Tag Cloud</h1>
    <span id="tag-cloud"><a href='/blog/categories/amazon-web-services' style='font-size: 115.0%'>amazon web services(1)</a> <a href='/blog/categories/cloud' style='font-size: 115.0%'>cloud(1)</a> <a href='/blog/categories/clustering' style='font-size: 145.0%'>clustering(3)</a> <a href='/blog/categories/database' style='font-size: 145.0%'>database(3)</a> <a href='/blog/categories/hardware' style='font-size: 115.0%'>hardware(1)</a> <a href='/blog/categories/java' style='font-size: 115.0%'>java(1)</a> <a href='/blog/categories/linux' style='font-size: 115.0%'>linux(1)</a> <a href='/blog/categories/macos' style='font-size: 115.0%'>macos(1)</a> <a href='/blog/categories/network' style='font-size: 160.0%'>network(4)</a> <a href='/blog/categories/python' style='font-size: 145.0%'>python(3)</a> <a href='/blog/categories/saltstack' style='font-size: 130.0%'>saltstack(2)</a> <a href='/blog/categories/security' style='font-size: 145.0%'>security(3)</a> </span>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - 2019 - Ivan Vari -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ivanvari-com';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'https://ivanvari.com/couchbase-quota-explained/';
        var disqus_url = 'https://ivanvari.com/couchbase-quota-explained/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
